version: 2

models:
    - name: desktop_mrp_billing
      description: >
        company generated report identifying billable Desktop MRPs completed.

      columns:
          - name: patient_id
            description: >
              company generated unique patient id.
            tests:
              - not_null

          - name: opportunity_id
            description: >
              Unique id associated with patient service opportunities.
            tests:
              - unique
              - not_null
              - dbt_utils.relationships_where:
                  to: ref('desktop_mrp_funnel')
                  field: opportunity_id
                  to_condition: desktop_mrp_completed = 1 and map_finalized_date is not null and days_between_discharge_dmrp_completed between 0 and 31

          - name: task_id
            description: >
              Unique id associated with Desktop MRP visit generated by Salesforce.
            tests:
              - unique
              - not_null

          - name: source_patient_id
            description: >
              Client provided unique patient id.

          - name: institution_id
            description: >
              company generated unique client id.

          - name: discharge_date
            description: >
              Date in EST of patient hospital discharge sourced from the ADT feed.

          - name: desktop_mrp_completed_date
            description: >
              Date and time in EST of MRP visit assigned by company Clinic in company Web App (Meds360).
            tests:
              - dbt_utils.expression_is_true:
                  expression: "::date > discharge_date"

          - name: med_list_id
            description: >
              unique id associated with specific med lists
            tests:
              - unique
              - not_null

          - name: pharmacist_user_id
            description: >
              company_used_id for pharmacist attached to the finalized med list.
            tests:
              - not_null

          - name: map_finalized_date
            description: >
              Date in EST of MAP finalization completed by company Clinic in company Web App (Meds360).
            tests:
              - dbt_utils.expression_is_true:
                  expression: ">= desktop_mrp_completed_date::date"

          - name: map_transmission_date
            description: >
              System-generated date and time in EST when MAP was sent to patient and provider.
            tests:
              - dbt_utils.expression_is_true:
                  expression: "::date >= map_finalized_date"

          - name: map_transmission_method
            description: >
              Communication method use to send MAP.

          - name: provider_npi
            description: >
              Provider npi to whom the MAP was sent.

          - name: provider_name
            description: >
              Provider name to whom the MAP was sent.

          - name: days_between_discharge_and_dmrp_completed
            description: >
              Difference between discharge date in EST and Desktop MRP completed date and time in EST.

          - name: days_between_dmrp_completed_and_map_finalized
            description: >
              Difference between Desktop MRP completed date and time in EST and MAP finalized date in EST.

          - name: days_between_map_finalized_and_transmission
            description: >
              Difference between MAP finalized date in EST and MAP transmission date.

          - name: days_between_discharge_and_map_transmission
            description: >
              Difference between discharge date in EST and MAP transmission date

          - name: "(patient_id || '-' || desktop_mrp_completed_date)"
            description: >
              Unique combination id of client-provided patient id and date in EST of MRP visit.
            tests:
              - dbt_utils.relationships_where:
                  to: ref('desktop_mrp_funnel')
                  field: "(patient_id || '-' || desktop_mrp_completed_date)"

      tests:
        - dbt_expectations.expect_compound_columns_to_be_unique:
            column_list: [ "patient_id", "discharge_date" ]
            ignore_row_if: "any_value_is_missing"
            quote_columns: false

        - dbt_expectations.expect_compound_columns_to_be_unique:
            column_list: [ "patient_id", "opportunity_id", "desktop_mrp_completed_date"]
            ignore_row_if: "any_value_is_missing"
            quote_columns: false
