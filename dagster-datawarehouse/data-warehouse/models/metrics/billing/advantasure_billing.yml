version: 2

models:
    - name: advantasure_billing
      description: >
        Cureatr generated report identifying billable MRPs completed for Advantasure patients.

      columns:
          - name: patient_id
            description: >
              Cureatr generated unique patient id.
            tests:
              - not_null

          - name: discharge_event_id
            description: >
              Unique id associated with patient hospital discharge triggering service to patient.
            tests:
              - unique
              - not_null

          - name: opportunity_id
            description: >
              Unique id associated with patient service opportunities.
            tests:
              - unique
              - not_null
              - dbt_utils.relationships_where:
                  to: ref('mrp_funnel')
                  field: opportunity_id
                  to_condition: institution_id = 'advantasure'
                  from_condition: patient_id not in ('614e410a178515ec4863c999', '6182e25ad90ae08eb9d33f90', '6182e2cfd90ae08eb9d3c2c0')

          - name: mrp_event_id
            description: >
              Unique id associated with MRP visit generated by Salesforce.
            tests:
              - unique
              - not_null

          - name: source_patient_id
            description: >
              Client provided unique patient id.

          - name: patient_contact_id
            description: >
              Salesforce generated unique patient id.

          - name: institution_id
            description: >
              Cureatr generated unique client id.

          - name: discharge_date
            description: >
              Date in EST of patient hospital discharge sourced from the ADT feed.

          - name: mrp_visit_date
            description: >
              Date and time in EST of MRP visit assigned by Cureatr Clinic in Cureatr Web App (Meds360).
            tests:
              - dbt_expectations.expect_column_values_to_not_be_null:
                  row_condition: "extract(year from mrp_visit_date) >= 2023 and datediff(hour, mrp_visit_date, map_finalized_date) <=24"

          - name: med_list_id
            description: >
              unique id associated with specific med lists
            tests:
              - unique
              - not_null

          - name: pharmacist_user_id
            description: >
              cureatr_used_id for pharmacist attached to the finalized med list.
            tests:
              - not_null

          - name: map_finalized_date
            description: >
              Date in EST of MAP finalization completed by Cureatr Clinic in Cureatr Web App (Meds360).

          - name: map_transmission_date
            description: >
              System-generated date and time in EST when MAP was sent to patient and provider.

          - name: map_transmission_method
            description: >
              Communication method use to send MAP.

          - name: provider_npi
            description: >
              Provider npi to whom the MAP was sent.

          - name: provider_name
            description: >
              Provider name to whom the MAP was sent.

          - name: days_between_discharge_and_visit
            description: >
              Difference between discharge date in EST and MRP visit date and time in EST.

          - name: days_between_visit_and_map_finalized
            description: >
              Difference between MRP visit date and time in EST and MAP finalized date in EST.

          - name: days_between_map_finalized_and_transmission
            description: >
              Difference between MAP finalized date in EST and MAP transmission date.

          - name: days_between_discharge_and_map_transmission
            description: >
              Difference between discharge date in EST and MAP transmission date.

          - name: "(patient_id || '-' || mrp_visit_date)"
            description: >
              unique id associated with MRP visit generated by salesforce
            tests:
              - unique
              - relationships:
                  to: ref('advantasure_map_sends')
                  field: "(patient_id || '-' || mrp_visit_date)"
              - not_null

          - name: "(patient_id || '-' || mrp_visit_date::date)"
            description: >
              Unique combination id of client-provided patient id and date in EST of MRP visit.
            tests:
              - dbt_utils.relationships_where:
                  to: ref('mrp_funnel')
                  field: "(patient_id || '-' || mrp_completed_date::date)"
                  to_condition: institution_id = 'advantasure'
                  from_condition: patient_id not in ('614e410a178515ec4863c999', '6182e25ad90ae08eb9d33f90', '6182e2cfd90ae08eb9d3c2c0')
      tests:
        - dbt_expectations.expect_compound_columns_to_be_unique:
            column_list: [ "patient_id", "discharge_date" ]
            ignore_row_if: "any_value_is_missing"
            quote_columns: false
            row_condition: "patient_id not in ('614e4281178515ec4865bf99','6182e25ad90ae08eb9d33f90','6182e2cfd90ae08eb9d3c2c0') 
                          and opportunity_id not in (
                          {% for opportunity_id in var('opportunity_id_tied_same_discharge_date', []) -%}
                                '{{ opportunity_id }}'
                                 {%- if not loop.last %},{{ '\n' }}{% endif %}
                            {%- endfor %})"

        - dbt_expectations.expect_compound_columns_to_be_unique:
            column_list: [ "patient_id", "opportunity_id", "mrp_visit_date"]
            ignore_row_if: "any_value_is_missing"
            quote_columns: false
            row_condition: "extract(year from mrp_visit_date) >= 2023"

        - dbt_expectations.expect_column_pair_values_A_to_be_greater_than_B:
            column_A: mrp_visit_date
            column_B: discharge_date
            or_equal: True
            row_condition: "extract(year from discharge_date) >= 2023 and discharge_date = mrp_visit_date::date"

        - dbt_expectations.expect_column_pair_values_A_to_be_greater_than_B:
            column_A: map_transmission_date
            column_B: map_finalized_date
            or_equal: True
            row_condition: "extract(year from map_finalized_date) >= 2023 and map_finalized_date = map_transmission_date::date"
