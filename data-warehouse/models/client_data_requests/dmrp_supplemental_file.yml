version: 2

models:
    - name: dmrp_supplemental_file
      description: >
        monthly supplemental file.  Must match billing report med list for med list.
      columns:
        - name: "(member_card_id || '-' || service_date)"
          description: >
            unique id associated with dMRP visit generated by salesforce
          tests:
            - unique
            - dbt_utils.relationships_where:
                to: ref('desktop_mrp_billing')
                field: "(source_patient_id || '-' || desktop_mrp_completed_date::date)"
                to_condition: map_finalized_date between date_trunc('month', current_date) - interval '1 month' and date_trunc('month', current_date) - interval '1 second'
            - not_null

        - name: member_card_id
          description: >
            Client provided unique patient id.
          tests:
            - not_null

        - name: member_first_name
          description: >
            First name of the member.
          tests:
            - not_null

        - name: member_last_name
          description: >
            Last name of the member.
          tests:
            - not_null

        - name: member_dob
          description: >
            Date of birth of member.
          tests:
            - not_null

        - name: member_gender
          description: >
            Gender of member.
          tests:
            - not_null

        - name: rendering_provider_npi
          description: >
            NPI of the pharmacist who authored or co-authored the MAP.
          tests:
            - not_null

        - name: service_date
          description: >
            Date the dMRP was completed.
          tests:
            - not_null
            - dbt_expectations.expect_column_values_to_be_of_type:
                column_type: date

        - name: cpt_cptii_hcpcs_code
          description: >
            Static field that should always have the value "1111F".
          tests:
            - not_null
            - accepted_values:
                values: [ "1111F" ]