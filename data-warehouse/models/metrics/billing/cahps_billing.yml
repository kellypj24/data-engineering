version: 2

models:
    - name: cahps_billing
      description: >
        Cureatr-generated report identifying billable CAHPS visit completed.

      columns:
        - name: patient_id
          description: >
            Cureatr-generated unique patient id.
          tests:
            - not_null

        - name: opportunity_id
          description: >
            Unique id associated with patient service opportunities.
          tests:
            - unique
            - not_null
            - dbt_utils.relationships_where:
                to: ref('fact_cahps_visit')
                field: opportunity_id

        - name: cahps_event_id
          description: >
            Unique id associated with CAHPS visit generated by Salesforce.
          tests:
            - unique
            - not_null

        - name: source_patient_id
          description: >
            Client-provided unique patient id.

        - name: patient_contact_id
          description: >
            Salesforce generated unique patient id.

        - name: institution_id
          description: >
            Cureatr-generated unique client id.

        - name: enrollment_date
          description: >
            Date Enrollment Attempt #1 was created.
          tests:
            - not_null

        - name: cahps_visit_date
          description: >
            Date and time in EST of CAHPS visit assigned by Cureatr Clinic in Cureatr Web App (Meds360).
          tests:
            - dbt_utils.expression_is_true:
                expression: "::date >= enrollment_date::date"

        - name: pharmacist_user_id
          description: >
            cureatr_used_id for pharmacist attached to the finalized MAP (Medication Access Plan).

        - name: map_finalized_date
          description: >
            Date in EST of MAP finalization completed by Cureatr Clinic in Cureatr Web App (Meds360).
          tests:
            - dbt_expectations.expect_column_values_to_not_be_null:
                row_condition: "datediff(hour, cahps_visit_date::date, current_date::date) >= 24"
            - dbt_utils.expression_is_true:
                expression: "::date >= cahps_visit_date::date"

        - name: map_status
          description: >
            Status of the MAP for a patient.
          tests:
            - dbt_expectations.expect_column_values_to_not_be_null:
                row_condition: "map_finalized_date is not null and datediff(hour, map_finalized_date::date, current_date::date) >= 24"

        - name: map_transmission_date
          description: >
            System-generated date and time in EST when MAP was sent to patient.
          tests:
            - dbt_expectations.expect_column_values_to_not_be_null:
                row_condition: "cahps_visit_date is not null and datediff(day, map_finalized_date::date, current_date::date) > 2"
            - dbt_utils.expression_is_true:
                expression: "::date >= map_finalized_date::date"

        - name: map_transmission_method
          description: >
            Communication method use to send MAP to patient.
          tests:
            - dbt_expectations.expect_column_values_to_not_be_null:
                row_condition: "map_transmission_date is not null and datediff(hour, map_transmission_date::date, current_date::date) >= 24"

        - name: sent_to_stakeholder
          description: >
            Indicates who the MAP was sent to (should always be patient).
          tests:
            - dbt_expectations.expect_column_values_to_not_be_null:
                row_condition: "map_transmission_date is not null and datediff(hour, map_transmission_date::date, current_date::date) >= 24"

        - name: days_between_enrollment_and_visit
          description: >
            Difference between enrollment date in EST and CAHPS visit date and time in EST.

        - name: days_between_visit_and_map_finalized
          description: >
            Difference between CAHPS visit date and time in EST and MAP finalized date in EST.

        - name: days_between_map_finalized_and_transmission
          description: >
            Difference between MAP finalized date in EST and MAP transmission date.

        - name: days_between_enrollment_and_map_transmission
          description: >
            Difference between enrollment date in EST and MAP transmission date.

        - name: "(patient_id || '-' || cahps_visit_date)"
          description: >
            unique id associated with CAHPS visit generated by salesforce
          tests:
            - unique
            - not_null

      tests:
        - dbt_expectations.expect_compound_columns_to_be_unique:
            column_list: [ "patient_id", "enrollment_date" ]
            ignore_row_if: "any_value_is_missing"
            quote_columns: false

        - dbt_expectations.expect_compound_columns_to_be_unique:
            column_list: [ "patient_id", "opportunity_id", "cahps_visit_date" ]
            ignore_row_if: "any_value_is_missing"
            quote_columns: false
